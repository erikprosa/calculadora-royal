<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora Royal — Mobile</title>

<!-- favicon (SVG) -->
<link rel="icon" href="https://raw.githubusercontent.com/erikprosa/calculadora-royal/2d83a7735140ea56946b9eb71d47e5c151829820/favicon.svg" type="image/svg+xml">
<link rel="shortcut icon" href="https://raw.githubusercontent.com/erikprosa/calculadora-royal/2d83a7735140ea56946b9eb71d47e5c151829820/favicon.svg" type="image/svg+xml">
<link rel="preload" href="https://raw.githubusercontent.com/erikprosa/calculadora-royal/2d83a7735140ea56946b9eb71d47e5c151829820/favicon.svg" as="image">

<meta name="theme-color" content="#ffffff" id="meta-theme-color" />
<style>
  /* -----------------------
     VARIÁVEIS DE TEMA (light / dark + tokens de texto + sizes)
     Edite aqui os --light-... e --dark-... para alterar o tema, inclusive tamanhos
     ----------------------- */
  :root{
    /* --- Light theme --- */
    --light-bg: #ffffff;
    --light-card: #ffffff;
    --light-accent: #23395B;
    --light-muted: #6b7280;
    --light-pink: #F8DCDC;
    --light-yellow: #FFFF66;
    --light-border: #111;

    /* text groups (light) */
    --light-label-text: #6b7280;
    --light-box-text: #23395B;
    --light-main-text: #12223a;
    --light-final-desc: #6b7280;
    --light-credit-developer: #6b7280;
    --light-credit-handle: #23395B;

    /* switch tokens (light) */
    --light-icon-active: #000000;
    --light-icon-inactive: #8a8a8a;
    --light-switch-track: #E6E6EA;
    --light-switch-knob: #FFFFFF;
    --light-switch-active-track: #D1D5DB;
    --light-switch-border: rgba(0,0,0,0.12);

    /* logo URLs for light/dark (editable) */
    --light-logo: url("https://raw.githubusercontent.com/erikprosa/calculadora-royal/2d83a7735140ea56946b9eb71d47e5c151829820/Logo.svg");
    --dark-logo: url("https://raw.githubusercontent.com/erikprosa/calculadora-royal/2d83a7735140ea56946b9eb71d47e5c151829820/Logo_White.svg");

    /* --- Sizes (light) --- */
    --light-logo-size: 125px;
    --light-icon-size: 12px;

    /* --- Dark theme --- */
    --dark-bg: #212830;
    --dark-card: #0f1720;
    --dark-accent: #23395B;
    --dark-muted: #A3A8B3;
    --dark-pink: #F8DCDC;
    --dark-yellow: #FFFF66;
    --dark-border: #dbdbdb;

    /* text groups (dark) */
    --dark-label-text: #A3A8B3;
    --dark-box-text: #23395B;
    --dark-main-text: #ffffff;
    --dark-final-desc: #6b7280;
    --dark-credit-developer: #6b7280;
    --dark-credit-handle: #c6c6c6;

    /* switch tokens (dark) */
    --dark-icon-active: #000000;
    --dark-icon-inactive: #8a8a8a;
    --dark-switch-track: #2b3035;
    --dark-switch-knob: #d3d3d3;
    --dark-switch-active-track: #3a3f45;
    --dark-switch-border: rgba(255,255,255,0.08);

    /* sizes (dark) */
    --dark-logo-size: 125px;
    --dark-icon-size: 12px;

    /* --- Section border tokens (light) --- */
    --light-section-border-color: rgba(35, 57, 91, 0.25);
    --light-section-border-width: 1px;
    --light-section-border-style: solid;
    --light-section-border-inset: 14px;

    /* --- Section border tokens (dark) --- */
    --dark-section-border-color: rgba(255, 255, 255, 0.25);
    --dark-section-border-width: 1px;
    --dark-section-border-style: solid;
    --dark-section-border-inset: 14px;

    /* derived (active) variables default to light */
    --bg: var(--light-bg);
    --card: var(--light-card);
    --accent: var(--light-accent);
    --muted: var(--light-muted);
    --pink: var(--light-pink);
    --yellow: var(--light-yellow);
    --border: var(--light-border);

    --icon-active: var(--light-icon-active);
    --icon-inactive: var(--light-icon-inactive);
    --switch-track: var(--light-switch-track);
    --switch-knob: var(--light-switch-knob);
    --switch-active-track: var(--light-switch-active-track);
    --switch-border: var(--light-switch-border);

    --label-text: var(--light-label-text);
    --box-text: var(--light-box-text);
    --main-text: var(--light-main-text);
    --final-desc: var(--light-final-desc);
    --credit-developer: var(--light-credit-developer);
    --credit-handle: var(--light-credit-handle);

    /* active section border variables */
    --section-border-color: var(--light-section-border-color);
    --section-border-width: var(--light-section-border-width);
    --section-border-style: var(--light-section-border-style);
    --section-border-inset: var(--light-section-border-inset);

    /* active sizes (derived) */
    --logo-size: var(--light-logo-size);
    --icon-size: var(--light-icon-size);

    /* layout sizes */
    --field-width: 60%;
    --radius: 8px;
    --box-height: 56px;

    /* switch geometry */
    --switch-w: 54px;
    --switch-h: 28px;

    /* --- FATOR PRESENTES (EXPLÍCITO: editar aqui para ajustar o percentual) --- */
    /* mantenha o valor em decimal: 0.30 = 30% */
    --presentes-factor: 0.30;
  }

  /* when dark theme active, remap derived variables to dark tokens */
  .theme-dark {
    --bg: var(--dark-bg);
    --card: var(--dark-card);
    --accent: var(--dark-accent);
    --muted: var(--dark-muted);
    --pink: var(--dark-pink);
    --yellow: var(--dark-yellow);
    --border: var(--dark-border);

    --icon-active: var(--dark-icon-active);
    --icon-inactive: var(--dark-icon-inactive);
    --switch-track: var(--dark-switch-track);
    --switch-knob: var(--dark-switch-knob);
    --switch-active-track: var(--dark-switch-active-track);
    --switch-border: var(--dark-switch-border);

    --label-text: var(--dark-label-text);
    --box-text: var(--dark-box-text);
    --main-text: var(--dark-main-text);
    --final-desc: var(--dark-final-desc);
    --credit-developer: var(--dark-credit-developer);
    --credit-handle: var(--dark-credit-handle);

    /* section border -> dark */
    --section-border-color: var(--dark-section-border-color);
    --section-border-width: var(--dark-section-border-width);
    --section-border-style: var(--dark-section-border-style);
    --section-border-inset: var(--dark-section-border-inset);

    /* sizes -> dark */
    --logo-size: var(--dark-logo-size);
    --icon-size: var(--dark-icon-size);
  }

  /* -----------------------
     LAYOUT / ESTILOS GERAIS
     ----------------------- */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;}
  body{
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--accent);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:18px 12px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition: background .22s ease, color .22s ease;
  }

  .wrap{ width:100%; max-width:520px; }
  .card{
    background: var(--card);
    border-radius:14px;
    padding:16px 14px 22px 14px;
    box-shadow: 0 8px 22px rgba(20,30,60,0.06);
    color: var(--accent);
    transition: background .22s ease, color .22s ease, box-shadow .22s ease;
    position: relative;
    overflow: visible;
  }

  .topImageWrap { display:flex; justify-content:center; margin-bottom:12px; }
  .topImageLink{
    width: var(--logo-size);
    height: var(--logo-size);
    border-radius:50%;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .topImage {
    width:100%;
    height:100%;
    display:block;
    object-fit:contain;
    max-width:100%;
  }

  h1{ font-size:18px;margin:0 0 10px; color:var(--main-text); text-align:center; font-weight:700; }
  .section-title{ text-align:center; margin-top:6px; font-weight:800; color:var(--main-text); }

  /* Pseudo-element separator with rounded ends */
  section{
    margin-top:10px;
    padding-top: calc(8px + var(--section-border-width));
    position: relative;
  }

  section::before{
    content: "";
    position: absolute;
    left: var(--section-border-inset);
    right: var(--section-border-inset);
    top: 0;
    height: var(--section-border-width);
    background: var(--section-border-color);
    border-radius: calc(var(--section-border-width) / 2);
    pointer-events: none;
  }

  .row{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:8px 0; }

  label{
    width:var(--field-width);
    text-align:left;
    font-size:13px;
    color:var(--label-text);
    font-weight:700;
    display:flex;
    align-items:baseline;
    gap:2px;
  }
  label small{ font-size:11px;color:var(--label-text);font-weight:400;margin-left:6px; }
  label small.dynamic{ font-size:12px;color:var(--label-text);font-weight:600;opacity:0.85;margin-left:6px; }

  .inputBox{
    width:var(--field-width);
    height:var(--box-height);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0 14px;
    border-radius:var(--radius);
    border:2px solid var(--border);
    font-weight:700;
    background:#fff;
    transition: background .18s ease, border-color .18s ease;
  }

  input.textInput, select.textInput{
    outline:none;border:none;background:transparent;width:100%;
    text-align:center;font-size:16px;font-weight:800;
    -webkit-appearance:none;-moz-appearance:none;appearance:none;
    color: var(--box-text); -webkit-text-fill-color: var(--box-text);
    direction: ltr; text-align-last: center; -moz-text-align-last: center;
  }

  select.textInput option{ text-align:center; color:var(--box-text); }
  select.textInput::-ms-expand { display: none; }

  .editableBox{ background: var(--pink); }
  .highlight{ background: var(--yellow); }
  .readonlyBox{ background: #f6f6f6; }

  .smallText{ font-size:12px; font-weight:600; color:var(--muted); text-align:center; }
  .balance{ font-size:16px; font-weight:800; color:var(--accent); text-align:center; }

  .note{ font-size:12px; color:var(--final-desc); text-align:center; margin-top:12px; }

  .signature{ font-size:13px;color:var(--credit-developer);text-align:center;margin-top:8px; }
  .signature .handle{ color:var(--credit-handle); font-weight:800; text-decoration:none; margin-left:6px; }
  .signature a{ color:inherit; text-decoration:none; font-weight:800; }

  /* -----------------------
     THEME SWITCH
     knob and icons use derived CSS variables (--switch-w, --switch-h, --icon-size)
     ----------------------- */
  .theme-container { display:flex; justify-content:center; margin-top:12px; margin-bottom:8px; }

  .switch {
    width: var(--switch-w);
    height: var(--switch-h);
    border-radius:999px;
    background: var(--switch-track);
    display:inline-flex; align-items:center; padding:4px; box-sizing:border-box;
    transition: background .18s ease, border-color .12s ease; position: relative; z-index:1;
    border: 2px solid var(--switch-border); overflow: visible;
  }

  .switch.active { background: var(--switch-active-track); }

  /* knob: contém os ícones, centraliza via flexbox */
  .knob {
    width: calc(var(--switch-h) - 8px);
    height: calc(var(--switch-h) - 8px);
    background: var(--switch-knob);
    border-radius:50%;
    position: absolute;
    left:4px;
    display:flex;
    align-items:center;
    justify-content:center;   /* centraliza os ícones */
    overflow:hidden;
    transition: transform .20s ease, background .18s ease;
    z-index:2;
  }

  .switch.active .knob {
    transform: translateX(calc(var(--switch-w) - var(--switch-h)));
  }

  /* ícones dentro do knob use --icon-size (set per theme) */
  .knob .icon-sun,
  .knob .icon-moon {
    width: var(--icon-size);
    height: var(--icon-size);
    position:absolute;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0;
    transition: opacity .18s ease, transform .18s ease;
    color: var(--icon-inactive);
    pointer-events:none;
  }

  .switch:not(.active) .knob .icon-sun {
    opacity:1;
    color: var(--icon-active);
    transform: scale(1);
  }

  .switch.active .knob .icon-moon {
    opacity:1;
    color: var(--icon-active);
    transform: scale(1);
  }

  /* forçar SVG a herdar currentColor */
  .knob svg path,
  .knob svg circle,
  .knob svg rect,
  .knob svg g {
    fill: currentColor !important;
    stroke: none !important;
  }

  @media (max-width:420px){
    :root{ --field-width:86%; }
    .topImageLink { width: calc(var(--logo-size) * 0.885); height: calc(var(--logo-size) * 0.885); }
  }
</style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="card" id="card" role="main" aria-label="Calculadora Royal mobile">
      <div class="topImageWrap">
        <a class="topImageLink" href="https://www.royalprestige.com/br" target="_blank" rel="noopener noreferrer" aria-label="Visitar Royal Prestige">
          <!-- topImage src will be set by JS according to theme -->
          <img class="topImage" src="" alt="Logo Royal Prestige" id="topLogo">
        </a>
      </div>

      <h1>Calculadora Royal</h1>

      <!-- DADOS PRINCIPAIS -->
      <section aria-labelledby="dados-title">
        <div class="row" id="dados-title">
          <label for="valorNeg">VALOR DE NEGOCIAÇÃO</label>
          <div class="inputBox editableBox" title="Valor de negociação">
            <!-- inicializado via JS para R$ 0,00 -->
            <input id="valorNeg" class="textInput" inputmode="decimal" type="text" value="R$ 0,00" aria-label="Valor de negociação">
          </div>
        </div>

        <div class="row">
          <label for="desconto">DESCONTO <small>(0% a 10%)</small></label>
          <div class="inputBox editableBox" title="Desconto percentual">
            <select id="desconto" class="textInput" aria-label="Desconto percentual"></select>
          </div>
        </div>

        <div class="row">
          <label>VALOR DE VENDA</label>
          <div class="inputBox readonlyBox" id="valorVendaBox" title="Valor de venda">
            <div id="valorVendaText" class="balance">R$ 0,00</div>
          </div>
        </div>
      </section>

      <!-- FINANCIAMENTO / BOLETO -->
      <section aria-labelledby="fin-title">
        <div class="section-title">FINANCIAMENTO / BOLETO</div>

        <div class="row" style="margin-top:10px">
          <label for="entrada">ENTRADA <small>(5% a 10%)</small></label>
          <div class="inputBox editableBox" title="Percentual de entrada">
            <select id="entrada" class="textInput" aria-label="Entrada percentual"></select>
          </div>
        </div>

        <div class="row">
          <label for="numParcelas">NÚMERO DE PARCELAS <small>(até 30x no boleto)</small></label>
          <div class="inputBox editableBox" title="Número de parcelas">
            <select id="numParcelas" class="textInput" aria-label="Número de parcelas"></select>
          </div>
        </div>

        <div class="row">
          <label>VALOR DA ENTRADA <small class="dynamic" id="labelValorEntradaSmall">(R$ 0,00 em 12x)</small></label>
          <div class="inputBox highlight" id="valorEntradaBox" title="Valor da entrada">
            <div id="valorEntradaText" class="balance">R$ 0,00</div>
          </div>
        </div>

        <div class="row">
          <label>VALOR DA PARCELA MENSAL</label>
          <div class="inputBox highlight" id="valorParcelaBox" title="Parcela mensal">
            <div id="valorParcelaText" class="balance">R$ 0,00</div>
          </div>
        </div>
      </section>

      <!-- CARTÃO -->
      <section aria-labelledby="cartao-title">
        <div class="section-title">CARTÃO DE CRÉDITO</div>

        <div class="row" style="margin-top:10px">
          <label for="cartao">CARTÃO <small>(sem juros)</small></label>
          <div class="inputBox editableBox" title="Parcelas no cartão">
            <select id="cartao" class="textInput" aria-label="Parcelas cartão"></select>
          </div>
        </div>

        <div class="row">
          <label>PARCELA NO CARTÃO</label>
          <div class="inputBox highlight" id="cartaoParcelaBox" title="Parcela cartão">
            <div id="cartaoParcelaText" class="balance">R$ 0,00</div>
          </div>
        </div>
      </section>

      <!-- TOTAIS -->
      <section aria-labelledby="totais-title">
        <div class="section-title">TOTAIS E INFORMAÇÕES FINAIS</div>

        <div class="row" style="margin-top:10px">
          <label>SALDO A PAGAR SEM JUROS</label>
          <div class="inputBox readonlyBox"><div id="saldoSemJurosText" class="balance">R$ 0,00</div></div>
        </div>

        <div class="row">
          <label>VALOR PARCELADO</label>
          <div class="inputBox readonlyBox"><div id="valorParceladoText" class="balance">R$ 0,00</div></div>
        </div>

        <div class="row">
          <label>PRIMEIRA PARCELA</label>
          <div class="inputBox readonlyBox"><div id="primeiraParcelaText" class="balance">--/--/----</div></div>
        </div>

        <div class="row">
          <label>VALOR TOTAL DA VENDA <small>(Incluindo juros e taxas)</small></label>
          <div class="inputBox readonlyBox"><div id="valorTotalVendaText" class="balance">R$ 0,00</div></div>
        </div>

        <div class="row">
          <label>MONTANTE TOTAL DE JUROS</label>
          <div class="inputBox readonlyBox"><div id="totalJurosText" class="balance">R$ 0,00</div></div>
        </div>
      </section>

      <!-- NOVO GRUPO: PRESENTES (ADICIONADO) -->
      <section aria-labelledby="presentes-title">
        <div class="section-title">PRESENTES</div>

        <div class="row" style="margin-top:10px">
          <label for="valorPresentes">VALOR PARA PRESENTES <small class="dynamic" id="presentesFactorSmall">(30%)</small></label>
          <div class="inputBox readonlyBox" title="Valor destinado a presentes">
            <div id="presentesValorText" class="balance">R$ 0,00</div>
          </div>
        </div>
      </section>

      <!-- THEME SWITCH: ícones injetados dentro o knob -->
      <div class="theme-container">
        <button id="themeSwitch" aria-pressed="false" class="switch" title="Alternar tema" type="button">
          <div class="knob">
            <span class="icon-sun" aria-hidden="true" data-src="https://raw.githubusercontent.com/erikprosa/calculadora-royal/c5582556e5e0dee0f2164f75f2dc54668195e1df/sol_full.svg"></span>
            <span class="icon-moon" aria-hidden="true" data-src="https://raw.githubusercontent.com/erikprosa/calculadora-royal/c5582556e5e0dee0f2164f75f2dc54668195e1df/lua_full.svg"></span>
          </div>
        </button>
      </div>

      <div class="note">Campos em <strong>rosa</strong> são editáveis. Campos em <strong>amarelo</strong> são os principais em destaque.</div>

      <div class="signature" aria-label="assinatura">
        <span class="developer">developed by</span>
        <a class="handle" href="https://wa.me/5512988855235" target="_blank" rel="noopener noreferrer">@erikprosa</a>
      </div>

    </div>
  </div>

<script>
/* -----------------------
   INJEÇÃO DOS SVGs DO SWITCH
   ----------------------- */
async function injectIcon(spanEl) {
  const url = spanEl.getAttribute('data-src');
  if (!url) return;
  try {
    const resp = await fetch(url, {cache: "no-cache"});
    if (!resp.ok) throw new Error('fetch failed');
    const txt = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(txt, "image/svg+xml");
    const svg = doc.querySelector('svg');
    if (!svg) throw new Error('no svg found');

    // remove any inline fill/stroke so currentColor works
    const elements = svg.querySelectorAll('[fill],[stroke]');
    elements.forEach(el=>{
      el.removeAttribute('fill');
      el.removeAttribute('stroke');
    });

    if (!svg.getAttribute('viewBox')) {
      const w = svg.getAttribute('width') || '24';
      const h = svg.getAttribute('height') || '24';
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
    }

    svg.style.display = 'block';
    svg.removeAttribute('width');
    svg.removeAttribute('height');

    spanEl.innerHTML = '';
    spanEl.appendChild(svg);
  } catch (err) {
    spanEl.innerHTML = '';
    const fallbackSvg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    fallbackSvg.setAttribute('viewBox','0 0 24 24');
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d','M12 4a1 1 0 110 2 6 6 0 100 12 1 1 0 110 2 8 8 0 110-16z');
    fallbackSvg.appendChild(path);
    spanEl.appendChild(fallbackSvg);
  }
}

/* Inject icons inside knob */
document.querySelectorAll('.knob .icon-sun, .knob .icon-moon').forEach(span => {
  injectIcon(span);
});

/* -----------------------
   THEME HANDLER (troca logo e persiste)
   ----------------------- */
(function themeInit(){
  const stored = localStorage.getItem('royal_theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  let current = stored || (prefersDark ? 'dark' : 'light');

  const switchBtn = document.getElementById('themeSwitch');
  const metaTheme = document.getElementById('meta-theme-color');
  const topLogoImg = document.getElementById('topLogo');

  function cssVarUrl(varName) {
    const raw = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    const m = raw.match(/url\((?:'|")?(.*?)(?:'|")?\)/);
    return m ? m[1] : raw;
  }

  function preloadImage(src){
    return new Promise((resolve)=> {
      const img = new Image();
      img.onload = () => resolve(src);
      img.onerror = () => resolve(src);
      img.src = src;
    });
  }

  async function applyTheme(theme){
    if (theme === 'dark'){
      document.body.classList.add('theme-dark');
      switchBtn.classList.add('active');
      switchBtn.setAttribute('aria-pressed','true');
    } else {
      document.body.classList.remove('theme-dark');
      switchBtn.classList.remove('active');
      switchBtn.setAttribute('aria-pressed','false');
    }

    const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || (theme === 'dark' ? '#212830' : '#ffffff');
    metaTheme.setAttribute('content', bg);

    const lightLogoUrl = cssVarUrl('--light-logo');
    const darkLogoUrl = cssVarUrl('--dark-logo');
    const target = theme === 'dark' ? darkLogoUrl : lightLogoUrl;
    try {
      await preloadImage(target);
      topLogoImg.setAttribute('src', target);
      topLogoImg.setAttribute('alt', theme === 'dark' ? 'Logo Royal (versão branca)' : 'Logo Royal');
    } catch (e) {
      topLogoImg.setAttribute('src', target);
    }

    localStorage.setItem('royal_theme', theme);
  }

  applyTheme(current);

  switchBtn.addEventListener('click', ()=>{
    current = (current === 'dark') ? 'light' : 'dark';
    applyTheme(current);
  });

  if (!stored && window.matchMedia){
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
      current = e.matches ? 'dark' : 'light';
      applyTheme(current);
    });
  }
})();

/* -----------------------
   CÁLCULOS E LÓGICA (ajuste para calcular total primeiro conforme sua fórmula)
   ----------------------- */
const brl = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});

function clamp(n, min, max){ if (isNaN(n)) return min; return Math.min(max, Math.max(min, n)); }
function parsePercentFromSelect(v){ const n = parseInt(String(v).replace('%',''),10); if (isNaN(n)) return 0; return n/100; }
function formatToBRLNumber(value){ return brl.format(value); }
function parseBRLStringToNumber(str){
  if (!str) return 0;
  let s = String(str).replace(/[R$\s]/g,'');
  s = s.replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
function formatCurrencyInputEl(el, rawValue){ el.value = formatToBRLNumber(round2(rawValue)); }
function addDaysAdjust(d0, days){
  const d = new Date(d0.getTime());
  d.setDate(d.getDate() + days);
  const day = d.getDate();
  if (day >= 29) {
    const m = d.getMonth(); const y = d.getFullYear();
    return new Date(y, m+1, 1);
  }
  return d;
}
function formatDateBR(d){ const dd = String(d.getDate()).padStart(2,'0'); const mm = String(d.getMonth()+1).padStart(2,'0'); const yyyy = d.getFullYear(); return dd + '/' + mm + '/' + yyyy; }

/* === ARREDONDAMENTO COMERCIAL (aplicado APENAS na parcela mensal) ===
   Regra: analisar a 3ª casa decimal:
     - se 0..5 => arredonda para baixo (trunca na 2ª casa)
     - se 6..9 => arredonda para cima (ceiling na 2ª casa)
   Observação: aplicada apenas a valores positivos (cenário de parcelas).
*/
function roundCommercial2(n){
  if (!isFinite(n)) return 0;
  // pegamos a parte inteira dos milésimos (3 casas) de forma estável
  const scaled = Math.floor(n * 1000 + 1e-9); // ex: 287.755 -> 287755
  const third = scaled % 10; // dígito da 3ª casa decimal
  if (third <= 5) {
    // arredonda para baixo (truncar para 2 casas)
    return Math.floor(n * 100 + 1e-9) / 100;
  } else {
    // arredonda para cima
    return Math.ceil(n * 100 - 1e-9) / 100;
  }
}

const elValorNeg = document.getElementById('valorNeg');
const elDesconto = document.getElementById('desconto');
const elEntrada = document.getElementById('entrada');
const elNumParcelas = document.getElementById('numParcelas');
const elCartao = document.getElementById('cartao');

const outValorVenda = document.getElementById('valorVendaText');
const outValorEntrada = document.getElementById('valorEntradaText');
const labelValorEntradaSmall = document.getElementById('labelValorEntradaSmall');
const outValorParcela = document.getElementById('valorParcelaText');
const outCartaoParcela = document.getElementById('cartaoParcelaText');
const outSaldoSemJuros = document.getElementById('saldoSemJurosText');
const outValorParcelado = document.getElementById('valorParceladoText');
const outPrimeiraParcela = document.getElementById('primeiraParcelaText');
const outValorTotalVenda = document.getElementById('valorTotalVendaText');
const outTotalJuros = document.getElementById('totalJurosText');

/* NOVO OUTPUT: PRESENTES */
const outPresentes = document.getElementById('presentesValorText');
const outPresentesFactorLabel = document.getElementById('presentesFactorSmall');

(function populateSelects(){
  // desconto 0..10
  for (let i=0;i<=10;i++){
    const opt = document.createElement('option'); opt.value = String(i) + '%'; opt.textContent = String(i) + '%';
    elDesconto.appendChild(opt);
  }
  // entrada 5..10
  for (let i=5;i<=10;i++){
    const opt = document.createElement('option'); opt.value = String(i) + '%'; opt.textContent = String(i) + '%';
    elEntrada.appendChild(opt);
  }
  // parcelas 1..30
  for (let i=1;i<=30;i++){
    const opt = document.createElement('option'); opt.value = String(i); opt.textContent = String(i) + 'x';
    elNumParcelas.appendChild(opt);
  }
  // cartao 1..18
  for (let i=1;i<=18;i++){
    const opt = document.createElement('option'); opt.value = String(i); opt.textContent = String(i) + 'x';
    elCartao.appendChild(opt);
  }

  // initial defaults requested: valorNeg = 0, desconto = 0
  elDesconto.value = '0%';
  elEntrada.value = '5%';
  elNumParcelas.value = '30';
  elCartao.value = '18';
})();

// taxaJurosMensal is kept but not used in the Excel formula approach for parcelas:
const taxaJurosMensal = 0.015; // (kept for reference)

function calcularTudo(){
  const valorNegStr = elValorNeg.value;
  const valorNeg = round2(parseBRLStringToNumber(valorNegStr));
  const desconto = parsePercentFromSelect(elDesconto.value);
  const entradaPercent = parsePercentFromSelect(elEntrada.value);
  let parcelas = parseInt(elNumParcelas.value,10) || 1;
  parcelas = clamp(parcelas,1,30);
  let cartaoParcelas = parseInt(elCartao.value,10) || 1;

  // Valor de venda após desconto
  const valorVenda = round2(valorNeg * (1 - desconto));

  // --- CÁLCULO DO VALOR PARA PRESENTES (NOVO) ---
  // lê o fator diretamente da variável CSS --presentes-factor (valores em decimal: 0.30 = 30%)
  const rawFactor = getComputedStyle(document.documentElement).getPropertyValue('--presentes-factor') || '0.30';
  // tenta interpretar como número, aceita '0.30' ou '30%' ou '0.3'
  let presentesFactor = 0.30;
  try {
    const trimmed = String(rawFactor).trim();
    if (trimmed.endsWith('%')) {
      presentesFactor = parseFloat(trimmed.replace('%',''))/100;
    } else {
      presentesFactor = parseFloat(trimmed);
      if (isNaN(presentesFactor)) presentesFactor = 0.30;
      // se valor > 1 e provavelmente foi colocado como '30', converte para 0.30
      if (presentesFactor > 1) presentsFactor = presentesFactor / 100;
    }
  } catch (e) {
    presentesFactor = 0.30;
  }
  // fallback seguro
  if (!isFinite(presentesFactor) || isNaN(presentesFactor)) presentesFactor = 0.30;

  // Valor da entrada
  const valorEntrada = round2(valorVenda * entradaPercent);

  // Saldo para parcelar (sem considerar "juros" convencionais)
  const saldoSemJuros = round2(valorVenda - valorEntrada);

  /*
     Correção aplicada:
     - calcular primeiro o TOTAL parcelado aplicando o fator (1 + parcelas/100)
     - arredondar o TOTAL (uma vez)
     - então derivar a parcela mensal dividindo o total pelo número de parcelas
     - A exceção: a parcela mensal **usa** o arredondamento comercial (roundCommercial2)
       conforme solicitado (3ª casa = 0..5 -> trunca; 6..9 -> sobe).
  */
  let paymentMonthly = 0;
  let totalParcelado = 0;
  if (parcelas === 1) {
    paymentMonthly = saldoSemJuros;
    totalParcelado = paymentMonthly;
  } else {
    const fator = 1 + (parcelas / 100); // ex: 1 + 30/100 = 1.3 para 30x
    totalParcelado = round2(saldoSemJuros * fator); // <-- total arredondado APÓS multiplicar
    // Aqui aplicamos o arredondamento comercial apenas na parcela mensal:
    paymentMonthly = roundCommercial2(totalParcelado / parcelas);
  }

  // Valor total da venda = entrada + total parcelado
  const valorTotalVenda = round2(valorEntrada + totalParcelado);

  // Montante de juros (diferença entre valor total e valorVenda)
  const totalJuros = round2(valorTotalVenda - valorVenda);

  // Parcela no cartão (sem juros)
  const cartaoParcela = cartaoParcelas > 0 ? round2(valorVenda / cartaoParcelas) : 0;

  // Primeira parcela (ajuste de data)
  const hoje = new Date();
  const primeira = addDaysAdjust(hoje,45);

  // --- CÁLCULO: Valor para presentes (30% por padrão via --presentes-factor) ---
  const valorPresentes = round2(valorVenda * presentesFactor);

  // Outputs
  formatCurrencyInputEl(elValorNeg, valorNeg);
  outValorVenda.textContent = formatToBRLNumber(valorVenda);
  outValorEntrada.textContent = formatToBRLNumber(valorEntrada);

  // entrada mostrada "em 12x" conforme seu pedido anterior
  const entradaPerParcel12 = round2(valorEntrada / 12);
  labelValorEntradaSmall.textContent = '(' + formatToBRLNumber(entradaPerParcel12) + ' em 12x)';

  // Agora o valor da parcela mensal segue o cálculo atualizado (total primeiro + roundCommercial2)
  outValorParcela.textContent = formatToBRLNumber(paymentMonthly);

  outCartaoParcela.textContent = formatToBRLNumber(cartaoParcela);
  outSaldoSemJuros.textContent = formatToBRLNumber(saldoSemJuros);
  outValorParcelado.textContent = formatToBRLNumber(totalParcelado);
  outPrimeiraParcela.textContent = formatDateBR(primeira);
  outValorTotalVenda.textContent = formatToBRLNumber(valorTotalVenda);
  outTotalJuros.textContent = formatToBRLNumber(totalJuros);

  // Output do novo campo "Valor para presentes"
  outPresentes.textContent = formatToBRLNumber(valorPresentes);
  // atualiza rótulo dinâmico com percentual (exibe '30%')
  outPresentesFactorLabel.textContent = '(' + (Math.round(presentesFactor * 100)) + '%)';
}

/* Input handlers */
function handleValorNegInput(e){
  const raw = e.target.value;
  let onlyNums = raw.replace(/[^\d]/g,'');
  if (onlyNums === '') { e.target.value = 'R$ 0,00'; calcularTudo(); return; }
  let asNumber = parseFloat(onlyNums) / 100;
  e.target.value = brl.format(asNumber);
  calcularTudo();
}

elValorNeg.addEventListener('input', handleValorNegInput);
elDesconto.addEventListener('change', calcularTudo);
elEntrada.addEventListener('change', calcularTudo);
elNumParcelas.addEventListener('change', calcularTudo);
elCartao.addEventListener('change', calcularTudo);

elValorNeg.addEventListener('blur', ()=>{
  const n = parseBRLStringToNumber(elValorNeg.value);
  formatCurrencyInputEl(elValorNeg, n);
  calcularTudo();
});

/* init: set initial valorNeg = 0 and desconto = 0 as requested */
(function init(){ 
  // ensure displayed initial value is R$ 0,00
  formatCurrencyInputEl(elValorNeg, 0);
  // selects already populated and defaults set in populateSelects
  calcularTudo(); 
})();
</script>
</body>
</html>
